import os
import google.generativeai as genai
from flask import Flask, request, jsonify
from flask_cors import CORS

# Ініціалізуємо Flask додаток
app = Flask(__name__)
# Дозволяємо запити з будь-якого домену (важливо для зв'язку з вашим сайтом)
CORS(app)

# --- НАЛАШТУВАННЯ БОТА ---
# Тут ми будемо отримувати API ключ з налаштувань хостингу Render
api_key = os.getenv("GEMINI_API_KEY")

# Перевіряємо, чи ключ існує, перш ніж налаштовувати genai
if api_key:
    genai.configure(api_key=api_key)
else:
    print("ПОПЕРЕДЖЕННЯ: Змінна середовища GEMINI_API_KEY не встановлена.")


# Налаштування моделі Gemini
generation_config = {
    "temperature": 0.9,
    "top_p": 1,
    "top_k": 1,
    "max_output_tokens": 2048,
}

model = genai.GenerativeModel(
    model_name="gemini-1.5-flash",
    generation_config=generation_config,
    # Системна інструкція - це "особистість" вашого бота.
    system_instruction="""Ти — експертний віртуальний консультант для сайту vet25ua.onrender.com.
Твоя спеціалізація — ветеринарія та безпека харчових продуктів. Відповідай виключно на запитання, пов'язані з:
- Ветеринарними препаратами, хворобами тварин.
- Нормами та стандартами харчової промисловості (ДСТУ, ISO, HACCP), а також з можливістю прописувати процедури HACCP.
- Технологіями виробництва та зберігання продуктів в Україні та Євросоюзі.
- Рекомендаціями щодо продажів в Україні та Євросоюзі.
- Клінічними ознаками хворих органів туш тварин, тушок птиці, качок, кролів, індиків, курей.
- Цінами на сільськогосподарську продукцію в Україні та Євросоюзі, аналізом та рекомендаціями для продажу.
- Аналізом хвороб бджіл та їх паразитів, рекомендаціями по лікуванню та усуненню хвороб.
- Способами обробки меду, методами зберігання та стандартами України та Євросоюзу.
- Рекомендаціями щодо кращого продажу меду і супутніх матеріалів (віск, пилок, перга, маточне молочко, тощо).
- Цінами на продукцію бджільництва в Україні та за кордоном.
- Законодавством України, Євросоюзу та інших країн щодо ветеринарії та експертизи м'яса.Закони та інструкції по хворобам сг тварин України.

Якщо запитання не стосується цих тем, ввічливо відмовляй у відповіді, пояснюючи свою спеціалізацію. Наприклад: 'Вибачте, я можу консультувати лише з питань ветеринарії та харчової промисловості'.
"""
)
# -------------------------

# Створюємо єдиний маршрут (endpoint) для нашого чату
@app.route('/api/chat', methods=['POST'])
def chat():
    if not api_key:
        return jsonify({"error": "API ключ не налаштовано на сервері. Зверніться до адміністратора."}), 500

    user_message = request.json.get("message")

    if not user_message:
        return jsonify({"error": "Повідомлення не може бути порожнім"}), 400

    try:
        chat_session = model.start_chat()
        response = chat_session.send_message(user_message)
        return jsonify({"reply": response.text})
    except Exception as e:
        return jsonify({"error": str(e)}), 500

# Додамо базовий маршрут, щоб перевірити, чи працює сервіс
@app.route('/')
def index():
    return "Бекенд чат-бота працює!"

# Ця частина потрібна для Render, щоб він знав, як запустити додаток
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=int(os.environ.get('PORT', 5000)))